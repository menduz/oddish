#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const semver = require("semver");
const git = require("git-rev-sync");
/**
 * Use cases
 *
 *  If no version is published, pick the version from the package.json and publish that version
 *
 *  If a version is published and the minor and major matches the package.json, publish a patch
 *
 *  If the packaje.json version minor and major differs from the published version, pick the latest published patch for the version of the package.json and increment the patch number
 *
 */
async function execute(command) {
    return new Promise((onSuccess, onError) => {
        child_process_1.exec(command, (error, stdout, stderr) => {
            stdout.length && console.log(stdout);
            stderr.length && console.error(stderr);
            if (error) {
                onError(stderr);
            }
            else {
                onSuccess(stdout);
            }
        });
    });
}
async function getBranch() {
    return git.branch();
}
async function setVersion(newVersion) {
    return await execute(`npm version ${newVersion} --force --no-git-tag-version --allow-same-version`);
}
async function publish(npmTag = []) {
    return await execute(`npm publish` + npmTag.map($ => ' --tag=' + $).join(''));
}
const fs = require("fs");
async function getVersion() {
    const json = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const pkgJsonVersion = json.version;
    const version = semver.parse(pkgJsonVersion.trim());
    if (!version) {
        throw new Error("Unable to parse semver from " + pkgJsonVersion);
    }
    return `${version.major}.${version.minor}.${version.patch}`;
}
async function getSnapshotVersion() {
    const commit = git.short();
    if (!commit) {
        throw new Error("Unable to get git commit");
    }
    const time = new Date().toISOString().replace(/(\..*$)/g, '').replace(/([^\dT])/g, '').replace('T', '.');
    return (await getVersion()) + '-' + time + '.' + commit;
}
console.log(`Current directory: ${process.cwd()}`);
const run = async () => {
    let branch = process.env.BRANCH_NAME || process.env.TRAVIS_BRANCH || (await getBranch());
    let npmTag = null;
    let gitTag = process.env.TRAVIS_TAG || null;
    let newVersion = null;
    console.log(`Using branch ${branch}`);
    // Travis keeps the branch name in the tags' builds
    if (gitTag) {
        if (semver.valid(gitTag)) {
            // If the tags is a valid semver, we publish using that version and without any npmTag
            npmTag = null;
            newVersion = gitTag;
        }
        else {
            npmTag = 'tag-' + gitTag;
            newVersion = await getSnapshotVersion();
        }
    }
    else if (branch === "master") {
        npmTag = "latest";
        newVersion = await getSnapshotVersion();
    }
    else if (branch === "develop") {
        npmTag = "next";
        newVersion = await getSnapshotVersion();
    }
    else if (branch.startsWith("dev-")) {
        npmTag = branch;
        newVersion = await getSnapshotVersion();
    }
    else {
        newVersion = await getSnapshotVersion();
    }
    console.log(`Publishing branch ${branch} with version=${newVersion} and tag=${npmTag || "<empty tag>"}`);
    await setVersion(newVersion);
    if (npmTag) {
        await publish([npmTag]);
    }
    else {
        await publish();
    }
    const repoName = (await execute('npm v . name')).trim();
    const extraTag = 'latest-' + (await getVersion());
    console.log(`Extra tag=${extraTag}`);
    await execute(`npm dist-tag add ${repoName}@${newVersion} ${extraTag}`);
};
run().catch(e => {
    console.error("Error:");
    console.error(e);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVibGlzaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInB1Ymxpc2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsaURBQXFDO0FBQ3JDLGlDQUFrQztBQUNsQyxvQ0FBcUM7QUFFckM7Ozs7Ozs7OztHQVNHO0FBRUgsS0FBSyxrQkFBa0IsT0FBTztJQUM1QixNQUFNLENBQUMsSUFBSSxPQUFPLENBQVMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUU7UUFDaEQsb0JBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3RDLE1BQU0sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNyQyxNQUFNLENBQUMsTUFBTSxJQUFJLE9BQU8sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFdkMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDVixPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDbEIsQ0FBQztZQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNOLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNwQixDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxLQUFLO0lBQ0gsTUFBTSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUN0QixDQUFDO0FBRUQsS0FBSyxxQkFBcUIsVUFBa0I7SUFDMUMsTUFBTSxDQUFDLE1BQU0sT0FBTyxDQUNsQixlQUFlLFVBQVUsb0RBQW9ELENBQzlFLENBQUM7QUFDSixDQUFDO0FBRUQsS0FBSyxrQkFBa0IsU0FBbUIsRUFBRTtJQUMxQyxNQUFNLENBQUMsTUFBTSxPQUFPLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxTQUFTLEdBQUcsQ0FB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QUFDLENBQUM7SUFDeEIsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2xCLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuaW1wb3J0IHsgZXhlYyB9IGZyb20gXCJjaGlsZF9wcm9jZXNzXCI7XG5pbXBvcnQgc2VtdmVyID0gcmVxdWlyZShcInNlbXZlclwiKTtcbmltcG9ydCBnaXQgPSByZXF1aXJlKFwiZ2l0LXJldi1zeW5jXCIpO1xuXG4vKipcbiAqIFVzZSBjYXNlc1xuICpcbiAqICBJZiBubyB2ZXJzaW9uIGlzIHB1Ymxpc2hlZCwgcGljayB0aGUgdmVyc2lvbiBmcm9tIHRoZSBwYWNrYWdlLmpzb24gYW5kIHB1Ymxpc2ggdGhhdCB2ZXJzaW9uXG4gKlxuICogIElmIGEgdmVyc2lvbiBpcyBwdWJsaXNoZWQgYW5kIHRoZSBtaW5vciBhbmQgbWFqb3IgbWF0Y2hlcyB0aGUgcGFja2FnZS5qc29uLCBwdWJsaXNoIGEgcGF0Y2hcbiAqXG4gKiAgSWYgdGhlIHBhY2thamUuanNvbiB2ZXJzaW9uIG1pbm9yIGFuZCBtYWpvciBkaWZmZXJzIGZyb20gdGhlIHB1Ymxpc2hlZCB2ZXJzaW9uLCBwaWNrIHRoZSBsYXRlc3QgcHVibGlzaGVkIHBhdGNoIGZvciB0aGUgdmVyc2lvbiBvZiB0aGUgcGFja2FnZS5qc29uIGFuZCBpbmNyZW1lbnQgdGhlIHBhdGNoIG51bWJlclxuICpcbiAqL1xuXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlKGNvbW1hbmQpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigob25TdWNjZXNzLCBvbkVycm9yKSA9PiB7XG4gICAgZXhlYyhjb21tYW5kLCAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICBzdGRvdXQubGVuZ3RoICYmIGNvbnNvbGUubG9nKHN0ZG91dCk7XG4gICAgICBzdGRlcnIubGVuZ3RoICYmIGNvbnNvbGUuZXJyb3Ioc3RkZXJyKTtcblxuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIG9uRXJyb3Ioc3RkZXJyKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9uU3VjY2VzcyhzdGRvdXQpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0QnJhbmNoKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gIHJldHVybiBnaXQuYnJhbmNoKCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNldFZlcnNpb24obmV3VmVyc2lvbjogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgcmV0dXJuIGF3YWl0IGV4ZWN1dGUoXG4gICAgYG5wbSB2ZXJzaW9uICR7bmV3VmVyc2lvbn0gLS1mb3JjZSAtLW5vLWdpdC10YWctdmVyc2lvbiAtLWFsbG93LXNhbWUtdmVyc2lvbmBcbiAgKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHVibGlzaChucG1UYWc6IHN0cmluZ1tdID0gW10pOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gYXdhaXQgZXhlY3V0ZShgbnBtIHB1Ymxpc2hgICsgbnBtVGFnLm1hcCgkID0+ICcgLS10YWc9JyArICQpLmpvaW4oJycpKTtcbn1cblxuaW1wb3J0IGZzID0gcmVxdWlyZShcImZzXCIpO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRWZXJzaW9uKCkge1xuICBjb25zdCBqc29uID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoJ3BhY2thZ2UuanNvbicsICd1dGY4JykpXG5cbiAgY29uc3QgcGtnSnNvblZlcnNpb24gPSBqc29uLnZlcnNpb247XG5cbiAgY29uc3QgdmVyc2lvbiA9IHNlbXZlci5wYXJzZShwa2dKc29uVmVyc2lvbi50cmltKCkpO1xuXG4gIGlmICghdmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlVuYWJsZSB0byBwYXJzZSBzZW12ZXIgZnJvbSBcIiArIHBrZ0pzb25WZXJzaW9uKTtcbiAgfVxuXG4gIHJldHVybiBgJHt2ZXJzaW9uLm1ham9yfS4ke3ZlcnNpb24ubWlub3J9LiR7dmVyc2lvbi5wYXRjaH1gO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTbmFwc2hvdFZlcnNpb24oKSB7XG4gIGNvbnN0IGNvbW1pdCA9IGdpdC5zaG9ydCgpO1xuICBpZiAoIWNvbW1pdCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlVuYWJsZSB0byBnZXQgZ2l0IGNvbW1pdFwiKTtcbiAgfVxuICBjb25zdCB0aW1lID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoLyhcXC4uKiQpL2csICcnKS5yZXBsYWNlKC8oW15cXGRUXSkvZywgJycpLnJlcGxhY2UoJ1QnLCAnLicpO1xuXG4gIHJldHVybiAoYXdhaXQgZ2V0VmVyc2lvbigpKSArICctJyArIHRpbWUgKyAnLicgKyBjb21taXQ7XG59XG5cbmNvbnNvbGUubG9nKGBDdXJyZW50IGRpcmVjdG9yeTogJHtwcm9jZXNzLmN3ZCgpfWApO1xuXG5jb25zdCBydW4gPSBhc3luYyAoKSA9PiB7XG4gIGxldCBicmFuY2ggPVxuICAgIHByb2Nlc3MuZW52LkJSQU5DSF9OQU1FIHx8IHByb2Nlc3MuZW52LlRSQVZJU19CUkFOQ0ggfHwgKGF3YWl0IGdldEJyYW5jaCgpKTtcblxuICBsZXQgbnBtVGFnOiBzdHJpbmcgPSBudWxsO1xuXG4gIGxldCBnaXRUYWc6IHN0cmluZyA9IHByb2Nlc3MuZW52LlRSQVZJU19UQUcgfHwgbnVsbDtcblxuICBsZXQgbmV3VmVyc2lvbjogc3RyaW5nID0gbnVsbDtcblxuICBjb25zb2xlLmxvZyhgVXNpbmcgYnJhbmNoICR7YnJhbmNofWApO1xuXG4gIC8vIFRyYXZpcyBrZWVwcyB0aGUgYnJhbmNoIG5hbWUgaW4gdGhlIHRhZ3MnIGJ1aWxkc1xuICBpZiAoZ2l0VGFnKSB7XG4gICAgaWYgKHNlbXZlci52YWxpZChnaXRUYWcpKSB7XG4gICAgICAvLyBJZiB0aGUgdGFncyBpcyBhIHZhbGlkIHNlbXZlciwgd2UgcHVibGlzaCB1c2luZyB0aGF0IHZlcnNpb24gYW5kIHdpdGhvdXQgYW55IG5wbVRhZ1xuICAgICAgbnBtVGFnID0gbnVsbDtcbiAgICAgIG5ld1ZlcnNpb24gPSBnaXRUYWc7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5wbVRhZyA9ICd0YWctJyArIGdpdFRhZztcbiAgICAgIG5ld1ZlcnNpb24gPSBhd2FpdCBnZXRTbmFwc2hvdFZlcnNpb24oKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAoYnJhbmNoID09PSBcIm1hc3RlclwiKSB7XG4gICAgbnBtVGFnID0gXCJsYXRlc3RcIjtcbiAgICBuZXdWZXJzaW9uID0gYXdhaXQgZ2V0U25hcHNob3RWZXJzaW9uKCk7XG4gIH0gZWxzZSBpZiAoYnJhbmNoID09PSBcImRldmVsb3BcIikge1xuICAgIG5wbVRhZyA9IFwibmV4dFwiO1xuICAgIG5ld1ZlcnNpb24gPSBhd2FpdCBnZXRTbmFwc2hvdFZlcnNpb24oKTtcbiAgfSBlbHNlIGlmIChicmFuY2guc3RhcnRzV2l0aChcImRldi1cIikpIHtcbiAgICBucG1UYWcgPSBicmFuY2g7XG4gICAgbmV3VmVyc2lvbiA9IGF3YWl0IGdldFNuYXBzaG90VmVyc2lvbigpO1xuICB9IGVsc2Uge1xuICAgIG5ld1ZlcnNpb24gPSBhd2FpdCBnZXRTbmFwc2hvdFZlcnNpb24oKTtcbiAgfVxuXG4gIGNvbnNvbGUubG9nKGBQdWJsaXNoaW5nIGJyYW5jaCAke2JyYW5jaH0gd2l0aCB2ZXJzaW9uPSR7bmV3VmVyc2lvbn0gYW5kIHRhZz0ke25wbVRhZyB8fCBcIjxlbXB0eSB0YWc+XCJ9YCk7XG5cbiAgYXdhaXQgc2V0VmVyc2lvbihuZXdWZXJzaW9uKTtcblxuXG4gIGlmIChucG1UYWcpIHtcbiAgICBhd2FpdCBwdWJsaXNoKFtucG1UYWddKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBwdWJsaXNoKCk7XG4gIH1cbiAgY29uc3QgcmVwb05hbWUgPSAoYXdhaXQgZXhlY3V0ZSgnbnBtIHYgLiBuYW1lJykpLnRyaW0oKTtcblxuICBjb25zdCBleHRyYVRhZyA9ICdsYXRlc3QtJyArIChhd2FpdCBnZXRWZXJzaW9uKCkpO1xuICBjb25zb2xlLmxvZyhgRXh0cmEgdGFnPSR7ZXh0cmFUYWd9YCk7XG4gIGF3YWl0IGV4ZWN1dGUoYG5wbSBkaXN0LXRhZyBhZGQgJHtyZXBvTmFtZX1AJHtuZXdWZXJzaW9ufSAke2V4dHJhVGFnfWApXG59O1xuXG5ydW4oKS5jYXRjaChlID0+IHtcbiAgY29uc29sZS5lcnJvcihcIkVycm9yOlwiKTtcbiAgY29uc29sZS5lcnJvcihlKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufSk7XG4iXX0=