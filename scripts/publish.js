#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const semver = require("semver");
const git = require("git-rev-sync");
/**
 * Use cases
 *
 *  If no version is published, pick the version from the package.json and publish that version
 *
 *  If a version is published and the minor and major matches the package.json, publish a patch
 *
 *  If the packaje.json version minor and major differs from the published version, pick the latest published patch for the version of the package.json and increment the patch number
 *
 */
async function execute(command) {
    return new Promise((onSuccess, onError) => {
        console.log(`Executing: '${command}'`);
        child_process_1.exec(command, (error, stdout, stderr) => {
            stdout.trim().length && console.log('stdout: ' + stdout.trim());
            stderr.trim().length && console.error('stderr: ' + stderr.trim());
            if (error) {
                onError(stderr);
            }
            else {
                onSuccess(stdout);
            }
        });
    });
}
async function getBranch() {
    return git.branch();
}
async function setVersion(newVersion) {
    return await execute(`npm version "${newVersion}" --force --no-git-tag-version --allow-same-version`);
}
async function publish(npmTag = []) {
    return await execute(`npm publish` + npmTag.map($ => ' "--tag=' + $ + '"').join(''));
}
const fs = require("fs");
async function getVersion() {
    const json = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const pkgJsonVersion = json.version;
    const version = semver.parse(pkgJsonVersion.trim());
    if (!version) {
        throw new Error("Unable to parse semver from " + pkgJsonVersion);
    }
    return `${version.major}.${version.minor}.${version.patch}`;
}
async function getSnapshotVersion() {
    const commit = git.short();
    if (!commit) {
        throw new Error("Unable to get git commit");
    }
    const time = new Date().toISOString().replace(/(\..*$)/g, '').replace(/([^\dT])/g, '').replace('T', '.');
    return (await getVersion()) + '-' + time + '.' + commit;
}
console.log(`Current directory: ${process.cwd()}`);
const run = async () => {
    let branch = process.env.BRANCH_NAME || process.env.TRAVIS_BRANCH || (await getBranch());
    let npmTag = null;
    let gitTag = process.env.TRAVIS_TAG || null;
    let newVersion = null;
    console.log(`Using branch ${branch}`);
    // Travis keeps the branch name in the tags' builds
    if (gitTag) {
        if (semver.valid(gitTag)) {
            // If the tags is a valid semver, we publish using that version and without any npmTag
            npmTag = null;
            newVersion = gitTag;
        }
        else {
            npmTag = 'tag-' + gitTag;
            newVersion = await getSnapshotVersion();
        }
    }
    else {
        newVersion = await getSnapshotVersion();
        if (branch === "master") {
            npmTag = "latest";
        }
        else if (branch === "develop") {
            npmTag = "next";
        }
        else if (branch.startsWith("dev-")) {
            npmTag = branch;
        }
    }
    console.log(`Publishing branch ${branch} with version=${newVersion} and tag=${npmTag || "<empty tag>"}`);
    await setVersion(newVersion);
    if (npmTag) {
        await publish([npmTag]);
    }
    else {
        await publish();
    }
    try {
        const repoName = (await execute('npm v . name')).trim();
        const extraTag = (npmTag ? 'latest-' : 'stable-') + (await getVersion());
        console.log(`Add dist tag ${extraTag} -> ${repoName}@${newVersion}`);
        await execute(`npm dist-tag add "${repoName}@${newVersion}" "${extraTag}"`);
    }
    catch (e) {
        console.error('Error setting extra npm dist-tag');
        console.error(e);
    }
};
run().catch(e => {
    console.error("Error:");
    console.error(e);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVibGlzaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInB1Ymxpc2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsaURBQXFDO0FBQ3JDLGlDQUFrQztBQUNsQyxvQ0FBcUM7QUFFckM7Ozs7Ozs7OztHQVNHO0FBRUgsS0FBSyxrQkFBa0IsT0FBTztJQUM1QixNQUFNLENBQUMsSUFBSSxPQUFPLENBQVMsQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLEVBQUU7UUFDaEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLE9BQU8sR0FBRyxDQUFDLENBQUM7UUFDdkMsb0JBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxFQUFFO1lBQ3RDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7WUFDaEUsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUVsRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNWLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsQixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3BCLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELEtBQUs7SUFDSCxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3RCLENBQUM7QUFFRCxLQUFLLHFCQUFxQixVQUFrQjtJQUMxQyxNQUFNLENBQUMsTUFBTSxPQUFPLENBQ2xCLGdCQUFnQixVQUFVLHFEQUFxRCxDQUNoRixDQUFD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QUFHLENBQUMsQ0FBQztJQUM5RSxDQUFDO0lBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNYLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUNsRCxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ25CLENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRixHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7SUFDZCxPQUFPLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hCLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDakIsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcbmltcG9ydCB7IGV4ZWMgfSBmcm9tIFwiY2hpbGRfcHJvY2Vzc1wiO1xuaW1wb3J0IHNlbXZlciA9IHJlcXVpcmUoXCJzZW12ZXJcIik7XG5pbXBvcnQgZ2l0ID0gcmVxdWlyZShcImdpdC1yZXYtc3luY1wiKTtcblxuLyoqXG4gKiBVc2UgY2FzZXNcbiAqXG4gKiAgSWYgbm8gdmVyc2lvbiBpcyBwdWJsaXNoZWQsIHBpY2sgdGhlIHZlcnNpb24gZnJvbSB0aGUgcGFja2FnZS5qc29uIGFuZCBwdWJsaXNoIHRoYXQgdmVyc2lvblxuICpcbiAqICBJZiBhIHZlcnNpb24gaXMgcHVibGlzaGVkIGFuZCB0aGUgbWlub3IgYW5kIG1ham9yIG1hdGNoZXMgdGhlIHBhY2thZ2UuanNvbiwgcHVibGlzaCBhIHBhdGNoXG4gKlxuICogIElmIHRoZSBwYWNrYWplLmpzb24gdmVyc2lvbiBtaW5vciBhbmQgbWFqb3IgZGlmZmVycyBmcm9tIHRoZSBwdWJsaXNoZWQgdmVyc2lvbiwgcGljayB0aGUgbGF0ZXN0IHB1Ymxpc2hlZCBwYXRjaCBmb3IgdGhlIHZlcnNpb24gb2YgdGhlIHBhY2thZ2UuanNvbiBhbmQgaW5jcmVtZW50IHRoZSBwYXRjaCBudW1iZXJcbiAqXG4gKi9cblxuYXN5bmMgZnVuY3Rpb24gZXhlY3V0ZShjb21tYW5kKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKG9uU3VjY2Vzcywgb25FcnJvcikgPT4ge1xuICAgIGNvbnNvbGUubG9nKGBFeGVjdXRpbmc6ICcke2NvbW1hbmR9J2ApO1xuICAgIGV4ZWMoY29tbWFuZCwgKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgc3Rkb3V0LnRyaW0oKS5sZW5ndGggJiYgY29uc29sZS5sb2coJ3N0ZG91dDogJyArIHN0ZG91dC50cmltKCkpO1xuICAgICAgc3RkZXJyLnRyaW0oKS5sZW5ndGggJiYgY29uc29sZS5lcnJvcignc3RkZXJyOiAnICsgc3RkZXJyLnRyaW0oKSk7XG5cbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBvbkVycm9yKHN0ZGVycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvblN1Y2Nlc3Moc3Rkb3V0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEJyYW5jaCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gZ2l0LmJyYW5jaCgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRWZXJzaW9uKG5ld1ZlcnNpb246IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIHJldHVybiBhd2FpdCBleGVjdXRlKFxuICAgIGBucG0gdmVyc2lvbiBcIiR7bmV3VmVyc2lvbn1cIiAtLWZvcmNlIC0tbm8tZ2l0LXRhZy12ZXJzaW9uIC0tYWxsb3ctc2FtZS12ZXJzaW9uYFxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwdWJsaXNoKG5wbVRhZzogc3RyaW5nW10gPSBbXSk6IFByb21pc2U8c3RyaW5nPiB7XG4gIHJldHVybiBhd2FpdCBleGVjdXRlKGBucG0gcHVibGlzaGAgKyBucG1UYWcubWFwKCQgPT4gJyBcIi0tdGFnPScgKyAkICsgJ1wiJykuam9pbignJykpO1xufVxuXG5pbXBvcnQgZnMgPSByZXF1aXJlKFwiZnNcIik7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFZlcnNpb24oKSB7XG4gIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYygncGFja2FnZS5qc29uJywgJ3V0ZjgnKSk7XG5cbiAgY29uc3QgcGtnSnNvblZlcnNpb24gPSBqc29uLnZlcnNpb247XG5cbiAgY29uc3QgdmVyc2lvbiA9IHNlbXZlci5wYXJzZShwa2dKc29uVmVyc2lvbi50cmltKCkpO1xuXG4gIGlmICghdmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlVuYWJsZSB0byBwYXJzZSBzZW12ZXIgZnJvbSBcIiArIHBrZ0pzb25WZXJzaW9uKTtcbiAgfVxuXG4gIHJldHVybiBgJHt2ZXJzaW9uLm1ham9yfS4ke3ZlcnNpb24ubWlub3J9LiR7dmVyc2lvbi5wYXRjaH1gO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTbmFwc2hvdFZlcnNpb24oKSB7XG4gIGNvbnN0IGNvbW1pdCA9IGdpdC5zaG9ydCgpO1xuICBpZiAoIWNvbW1pdCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlVuYWJsZSB0byBnZXQgZ2l0IGNvbW1pdFwiKTtcbiAgfVxuICBjb25zdCB0aW1lID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoLyhcXC4uKiQpL2csICcnKS5yZXBsYWNlKC8oW15cXGRUXSkvZywgJycpLnJlcGxhY2UoJ1QnLCAnLicpO1xuXG4gIHJldHVybiAoYXdhaXQgZ2V0VmVyc2lvbigpKSArICctJyArIHRpbWUgKyAnLicgKyBjb21taXQ7XG59XG5cbmNvbnNvbGUubG9nKGBDdXJyZW50IGRpcmVjdG9yeTogJHtwcm9jZXNzLmN3ZCgpfWApO1xuXG5jb25zdCBydW4gPSBhc3luYyAoKSA9PiB7XG4gIGxldCBicmFuY2ggPVxuICAgIHByb2Nlc3MuZW52LkJSQU5DSF9OQU1FIHx8IHByb2Nlc3MuZW52LlRSQVZJU19CUkFOQ0ggfHwgKGF3YWl0IGdldEJyYW5jaCgpKTtcblxuICBsZXQgbnBtVGFnOiBzdHJpbmcgPSBudWxsO1xuXG4gIGxldCBnaXRUYWc6IHN0cmluZyA9IHByb2Nlc3MuZW52LlRSQVZJU19UQUcgfHwgbnVsbDtcblxuICBsZXQgbmV3VmVyc2lvbjogc3RyaW5nID0gbnVsbDtcblxuICBjb25zb2xlLmxvZyhgVXNpbmcgYnJhbmNoICR7YnJhbmNofWApO1xuXG4gIC8vIFRyYXZpcyBrZWVwcyB0aGUgYnJhbmNoIG5hbWUgaW4gdGhlIHRhZ3MnIGJ1aWxkc1xuICBpZiAoZ2l0VGFnKSB7XG4gICAgaWYgKHNlbXZlci52YWxpZChnaXRUYWcpKSB7XG4gICAgICAvLyBJZiB0aGUgdGFncyBpcyBhIHZhbGlkIHNlbXZlciwgd2UgcHVibGlzaCB1c2luZyB0aGF0IHZlcnNpb24gYW5kIHdpdGhvdXQgYW55IG5wbVRhZ1xuICAgICAgbnBtVGFnID0gbnVsbDtcbiAgICAgIG5ld1ZlcnNpb24gPSBnaXRUYWc7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5wbVRhZyA9ICd0YWctJyArIGdpdFRhZztcbiAgICAgIG5ld1ZlcnNpb24gPSBhd2FpdCBnZXRTbmFwc2hvdFZlcnNpb24oKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbmV3VmVyc2lvbiA9IGF3YWl0IGdldFNuYXBzaG90VmVyc2lvbigpO1xuXG4gICAgaWYgKGJyYW5jaCA9PT0gXCJtYXN0ZXJcIikge1xuICAgICAgbnBtVGFnID0gXCJsYXRlc3RcIjtcbiAgICB9IGVsc2UgaWYgKGJyYW5jaCA9PT0gXCJkZXZlbG9wXCIpIHtcbiAgICAgIG5wbVRhZyA9IFwibmV4dFwiO1xuICAgIH0gZWxzZSBpZiAoYnJhbmNoLnN0YXJ0c1dpdGgoXCJkZXYtXCIpKSB7XG4gICAgICBucG1UYWcgPSBicmFuY2g7XG4gICAgfVxuICB9XG5cbiAgY29uc29sZS5sb2coYFB1Ymxpc2hpbmcgYnJhbmNoICR7YnJhbmNofSB3aXRoIHZlcnNpb249JHtuZXdWZXJzaW9ufSBhbmQgdGFnPSR7bnBtVGFnIHx8IFwiPGVtcHR5IHRhZz5cIn1gKTtcblxuICBhd2FpdCBzZXRWZXJzaW9uKG5ld1ZlcnNpb24pO1xuXG5cbiAgaWYgKG5wbVRhZykge1xuICAgIGF3YWl0IHB1Ymxpc2goW25wbVRhZ10pO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHB1Ymxpc2goKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgcmVwb05hbWUgPSAoYXdhaXQgZXhlY3V0ZSgnbnBtIHYgLiBuYW1lJykpLnRyaW0oKTtcbiAgICBjb25zdCBleHRyYVRhZyA9IChucG1UYWcgPyAnbGF0ZXN0LScgOiAnc3RhYmxlLScpICsgKGF3YWl0IGdldFZlcnNpb24oKSk7XG4gICAgY29uc29sZS5sb2coYEFkZCBkaXN0IHRhZyAke2V4dHJhVGFnfSAtPiAke3JlcG9OYW1lfUAke25ld1ZlcnNpb259YCk7XG4gICAgYXdhaXQgZXhlY3V0ZShgbnBtIGRpc3QtdGFnIGFkZCBcIiR7cmVwb05hbWV9QCR7bmV3VmVyc2lvbn1cIiBcIiR7ZXh0cmFUYWd9XCJgKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHNldHRpbmcgZXh0cmEgbnBtIGRpc3QtdGFnJyk7XG4gICAgY29uc29sZS5lcnJvcihlKTtcbiAgfVxufTtcblxucnVuKCkuY2F0Y2goZSA9PiB7XG4gIGNvbnNvbGUuZXJyb3IoXCJFcnJvcjpcIik7XG4gIGNvbnNvbGUuZXJyb3IoZSk7XG4gIHByb2Nlc3MuZXhpdCgxKTtcbn0pO1xuIl19