#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process_1 = require("child_process");
const semver = require("semver");
const git = require("git-rev-sync");
console.log(`> oddish`);
/**
 * Use cases
 *
 *  If no version is published, pick the version from the package.json and publish that version
 *
 *  If a version is published and the minor and major matches the package.json, publish a patch
 *
 *  If the packaje.json version minor and major differs from the published version, pick the latest published patch for the version of the package.json and increment the patch number
 *
 */
async function execute(command) {
    return new Promise((onSuccess, onError) => {
        console.log(`> ${command}`);
        child_process_1.exec(command, (error, stdout, stderr) => {
            stdout.trim().length && console.log('  ' + stdout.replace(/\n/g, '\n  '));
            stderr.trim().length && console.error('! ' + stderr.replace(/\n/g, '\n  '));
            if (error) {
                onError(stderr);
            }
            else {
                onSuccess(stdout);
            }
        });
    });
}
async function getBranch() {
    return git.branch();
}
async function setVersion(newVersion) {
    return await execute(`npm version "${newVersion}" --force --no-git-tag-version --allow-same-version`);
}
async function publish(npmTag = []) {
    return await execute(`npm publish` + npmTag.map($ => ' "--tag=' + $ + '"').join(''));
}
const fs = require("fs");
async function getVersion() {
    const json = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const pkgJsonVersion = json.version;
    const version = semver.parse(pkgJsonVersion.trim());
    if (!version) {
        throw new Error("Unable to parse semver from " + pkgJsonVersion);
    }
    return `${version.major}.${version.minor}.${version.patch}`;
}
async function getSnapshotVersion() {
    const commit = git.short();
    if (!commit) {
        throw new Error("Unable to get git commit");
    }
    const time = new Date().toISOString().replace(/(\..*$)/g, '').replace(/([^\dT])/g, '').replace('T', '');
    return (await getVersion()) + '-' + time + '.commit-' + commit;
}
async function getReleaseTags() {
    try {
        return JSON.parse(await execute('npm info . dist-tags --json'));
    }
    catch (_a) {
        return {};
    }
}
console.log(`  pwd: ${process.cwd()}`);
const run = async () => {
    let branch = process.env.BRANCH_NAME || process.env.TRAVIS_BRANCH || (await getBranch());
    let npmTag = null;
    let gitTag = process.env.TRAVIS_TAG || null;
    let newVersion = null;
    let linkLatest = false;
    console.log(`  branch: ${branch}`);
    // Travis keeps the branch name in the tags' builds
    if (gitTag) {
        if (semver.valid(gitTag)) {
            // If the tags is a valid semver, we publish using that version and without any npmTag
            npmTag = "latest-" + (await getVersion());
            linkLatest = true;
            newVersion = gitTag;
        }
        else {
            npmTag = 'tag-' + gitTag;
            newVersion = await getSnapshotVersion();
        }
    }
    else {
        newVersion = await getSnapshotVersion();
        if (branch === "master") {
            npmTag = "latest-" + (await getVersion());
        }
        else if (branch === "develop") {
            npmTag = "latest-" + (await getVersion());
        }
        else {
            npmTag = "branch-" + branch + (await getVersion());
        }
    }
    console.log(`  currentVersion: ${await getVersion()}`);
    console.log(`  publishing:\n    version: ${newVersion}`);
    console.log(`    tag: ${npmTag || "ci"}\n`);
    const tags = await getReleaseTags();
    if (npmTag && (npmTag in tags)) {
        if (semver.gte(tags[npmTag], newVersion)) {
            console.log(`! This version will be not published as "${npmTag}" because a newer version is set. Publishing as "ci"\n`);
            npmTag = null;
        }
    }
    await setVersion(newVersion);
    if (npmTag) {
        await publish([npmTag]);
    }
    else {
        await publish(['ci']);
    }
    if (linkLatest) {
        try {
            if (!tags.latest || semver.gte(newVersion, tags.latest)) {
                const pkgName = (await execute(`npm info . name`)).trim();
                await execute(`npm dist-tag add ${pkgName}@${newVersion} latest`);
            }
        }
        catch (e) {
            console.error(e);
        }
    }
    await execute(`npm info . dist-tags --json`);
};
run().catch(e => {
    console.error("Error:");
    console.error(e);
    process.exit(1);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHVibGlzaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInB1Ymxpc2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsaURBQXFDO0FBQ3JDLGlDQUFrQztBQUNsQyxvQ0FBcUM7QUFFckMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUV4Qjs7Ozs7Ozs7O0dBU0c7QUFFSCxLQUFLLGtCQUFrQixPQUFPO0lBQzVCLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBUyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRTtRQUNoRCxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssT0FBTyxFQUFFLENBQUMsQ0FBQztRQUM1QixvQkFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDdEMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQzFFLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUU1RSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUNWLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsQixDQUFDO1lBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ04sU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3BCLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQztBQUVELEtBQUs7SUFDSCxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3RCLENBQUM7QUFF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Q0FBQztJQUVELE1BQU0sT0FBTyxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFDL0MsQ0FBQyxDQUFDO0FBRUYsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO0lBQ2QsT0FBTyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUN4QixPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pCLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEIsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG5pbXBvcnQgeyBleGVjIH0gZnJvbSBcImNoaWxkX3Byb2Nlc3NcIjtcbmltcG9ydCBzZW12ZXIgPSByZXF1aXJlKFwic2VtdmVyXCIpO1xuaW1wb3J0IGdpdCA9IHJlcXVpcmUoXCJnaXQtcmV2LXN5bmNcIik7XG5cbmNvbnNvbGUubG9nKGA+IG9kZGlzaGApO1xuXG4vKipcbiAqIFVzZSBjYXNlc1xuICpcbiAqICBJZiBubyB2ZXJzaW9uIGlzIHB1Ymxpc2hlZCwgcGljayB0aGUgdmVyc2lvbiBmcm9tIHRoZSBwYWNrYWdlLmpzb24gYW5kIHB1Ymxpc2ggdGhhdCB2ZXJzaW9uXG4gKlxuICogIElmIGEgdmVyc2lvbiBpcyBwdWJsaXNoZWQgYW5kIHRoZSBtaW5vciBhbmQgbWFqb3IgbWF0Y2hlcyB0aGUgcGFja2FnZS5qc29uLCBwdWJsaXNoIGEgcGF0Y2hcbiAqXG4gKiAgSWYgdGhlIHBhY2thamUuanNvbiB2ZXJzaW9uIG1pbm9yIGFuZCBtYWpvciBkaWZmZXJzIGZyb20gdGhlIHB1Ymxpc2hlZCB2ZXJzaW9uLCBwaWNrIHRoZSBsYXRlc3QgcHVibGlzaGVkIHBhdGNoIGZvciB0aGUgdmVyc2lvbiBvZiB0aGUgcGFja2FnZS5qc29uIGFuZCBpbmNyZW1lbnQgdGhlIHBhdGNoIG51bWJlclxuICpcbiAqL1xuXG5hc3luYyBmdW5jdGlvbiBleGVjdXRlKGNvbW1hbmQpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigob25TdWNjZXNzLCBvbkVycm9yKSA9PiB7XG4gICAgY29uc29sZS5sb2coYD4gJHtjb21tYW5kfWApO1xuICAgIGV4ZWMoY29tbWFuZCwgKGVycm9yLCBzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgc3Rkb3V0LnRyaW0oKS5sZW5ndGggJiYgY29uc29sZS5sb2coJyAgJyArIHN0ZG91dC5yZXBsYWNlKC9cXG4vZywgJ1xcbiAgJykpO1xuICAgICAgc3RkZXJyLnRyaW0oKS5sZW5ndGggJiYgY29uc29sZS5lcnJvcignISAnICsgc3RkZXJyLnJlcGxhY2UoL1xcbi9nLCAnXFxuICAnKSk7XG5cbiAgICAgIGlmIChlcnJvcikge1xuICAgICAgICBvbkVycm9yKHN0ZGVycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvblN1Y2Nlc3Moc3Rkb3V0KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEJyYW5jaCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gZ2l0LmJyYW5jaCgpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzZXRWZXJzaW9uKG5ld1ZlcnNpb246IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gIHJldHVybiBhd2FpdCBleGVjdXRlKFxuICAgIGBucG0gdmVyc2lvbiBcIiR7bmV3VmVyc2lvbn1cIiAtLWZvcmNlIC0tbm8tZ2l0LXRhZy12ZXJzaW9uIC0tYWxsb3ctc2FtZS12ZXJzaW9uYFxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwdWJsaXNoKG5wbVRhZzogc3RyaW5nW10gPSBbXSk6IFByb21pc2U8c3RyaW5nPiB7XG4gIHJldHVybiBhd2FpdCBleGVjdXRlKGBucG0gcHVibGlzaGAgKyBucG1UYWcubWFwKCQgPT4gJyBcIi0tdGFnPScgKyAkICsgJ1wiJykuam9pbignJykpO1xufVxuXG5pbXBvcnQgZnMgPSByZXF1aXJlKFwiZnNcIik7XG5cbmFzeW5jIGZ1bmN0aW9uIGdldFZlcnNpb24oKSB7XG4gIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYygncGFja2FnZS5qc29uJywgJ3V0ZjgnKSk7XG5cbiAgY29uc3QgcGtnSnNvblZlcnNpb24gPSBqc29uLnZlcnNpb247XG5cbiAgY29uc3QgdmVyc2lvbiA9IHNlbXZlci5wYXJzZShwa2dKc29uVmVyc2lvbi50cmltKCkpO1xuXG4gIGlmICghdmVyc2lvbikge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlVuYWJsZSB0byBwYXJzZSBzZW12ZXIgZnJvbSBcIiArIHBrZ0pzb25WZXJzaW9uKTtcbiAgfVxuXG4gIHJldHVybiBgJHt2ZXJzaW9uLm1ham9yfS4ke3ZlcnNpb24ubWlub3J9LiR7dmVyc2lvbi5wYXRjaH1gO1xufVxuXG5cblxuYXN5bmMgZnVuY3Rpb24gZ2V0U25hcHNob3RWZXJzaW9uKCkge1xuICBjb25zdCBjb21taXQgPSBnaXQuc2hvcnQoKTtcbiAgaWYgKCFjb21taXQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmFibGUgdG8gZ2V0IGdpdCBjb21taXRcIik7XG4gIH1cbiAgY29uc3QgdGltZSA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKS5yZXBsYWNlKC8oXFwuLiokKS9nLCAnJykucmVwbGFjZSgvKFteXFxkVF0pL2csICcnKS5yZXBsYWNlKCdUJywgJycpO1xuXG4gIHJldHVybiAoYXdhaXQgZ2V0VmVyc2lvbigpKSArICctJyArIHRpbWUgKyAnLmNvbW1pdC0nICsgY29tbWl0O1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRSZWxlYXNlVGFncygpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gSlNPTi5wYXJzZShhd2FpdCBleGVjdXRlKCducG0gaW5mbyAuIGRpc3QtdGFncyAtLWpzb24nKSk7XG4gIH0gY2F0Y2gge1xuICAgIHJldHVybiB7fTtcbiAgfVxufVxuXG5jb25zb2xlLmxvZyhgICBwd2Q6ICR7cHJvY2Vzcy5jd2QoKX1gKTtcblxuY29uc3QgcnVuID0gYXN5bmMgKCkgPT4ge1xuICBsZXQgYnJhbmNoID1cbiAgICBwcm9jZXNzLmVudi5CUkFOQ0hfTkFNRSB8fCBwcm9jZXNzLmVudi5UUkFWSVNfQlJBTkNIIHx8IChhd2FpdCBnZXRCcmFuY2goKSk7XG5cbiAgbGV0IG5wbVRhZzogc3RyaW5nID0gbnVsbDtcblxuICBsZXQgZ2l0VGFnOiBzdHJpbmcgPSBwcm9jZXNzLmVudi5UUkFWSVNfVEFHIHx8IG51bGw7XG5cbiAgbGV0IG5ld1ZlcnNpb246IHN0cmluZyA9IG51bGw7XG5cbiAgbGV0IGxpbmtMYXRlc3QgPSBmYWxzZTtcblxuICBjb25zb2xlLmxvZyhgICBicmFuY2g6ICR7YnJhbmNofWApO1xuXG4gIC8vIFRyYXZpcyBrZWVwcyB0aGUgYnJhbmNoIG5hbWUgaW4gdGhlIHRhZ3MnIGJ1aWxkc1xuICBpZiAoZ2l0VGFnKSB7XG4gICAgaWYgKHNlbXZlci52YWxpZChnaXRUYWcpKSB7XG4gICAgICAvLyBJZiB0aGUgdGFncyBpcyBhIHZhbGlkIHNlbXZlciwgd2UgcHVibGlzaCB1c2luZyB0aGF0IHZlcnNpb24gYW5kIHdpdGhvdXQgYW55IG5wbVRhZ1xuICAgICAgbnBtVGFnID0gXCJsYXRlc3QtXCIgKyAoYXdhaXQgZ2V0VmVyc2lvbigpKTtcbiAgICAgIGxpbmtMYXRlc3QgPSB0cnVlO1xuICAgICAgbmV3VmVyc2lvbiA9IGdpdFRhZztcbiAgICB9IGVsc2Uge1xuICAgICAgbnBtVGFnID0gJ3RhZy0nICsgZ2l0VGFnO1xuICAgICAgbmV3VmVyc2lvbiA9IGF3YWl0IGdldFNuYXBzaG90VmVyc2lvbigpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBuZXdWZXJzaW9uID0gYXdhaXQgZ2V0U25hcHNob3RWZXJzaW9uKCk7XG5cbiAgICBpZiAoYnJhbmNoID09PSBcIm1hc3RlclwiKSB7XG4gICAgICBucG1UYWcgPSBcImxhdGVzdC1cIiArIChhd2FpdCBnZXRWZXJzaW9uKCkpO1xuICAgIH0gZWxzZSBpZiAoYnJhbmNoID09PSBcImRldmVsb3BcIikge1xuICAgICAgbnBtVGFnID0gXCJsYXRlc3QtXCIgKyAoYXdhaXQgZ2V0VmVyc2lvbigpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbnBtVGFnID0gXCJicmFuY2gtXCIgKyBicmFuY2ggKyAoYXdhaXQgZ2V0VmVyc2lvbigpKTtcbiAgICB9XG4gIH1cblxuICBjb25zb2xlLmxvZyhgICBjdXJyZW50VmVyc2lvbjogJHthd2FpdCBnZXRWZXJzaW9uKCl9YCk7XG4gIGNvbnNvbGUubG9nKGAgIHB1Ymxpc2hpbmc6XFxuICAgIHZlcnNpb246ICR7bmV3VmVyc2lvbn1gKTtcblxuXG5cbiAgY29uc29sZS5sb2coYCAgICB0YWc6ICR7bnBtVGFnIHx8IFwiY2lcIn1cXG5gKTtcblxuXG4gIGNvbnN0IHRhZ3MgPSBhd2FpdCBnZXRSZWxlYXNlVGFncygpO1xuXG4gIGlmIChucG1UYWcgJiYgKG5wbVRhZyBpbiB0YWdzKSkge1xuICAgIGlmIChzZW12ZXIuZ3RlKHRhZ3NbbnBtVGFnXSwgbmV3VmVyc2lvbikpIHtcbiAgICAgIGNvbnNvbGUubG9nKGAhIFRoaXMgdmVyc2lvbiB3aWxsIGJlIG5vdCBwdWJsaXNoZWQgYXMgXCIke25wbVRhZ31cIiBiZWNhdXNlIGEgbmV3ZXIgdmVyc2lvbiBpcyBzZXQuIFB1Ymxpc2hpbmcgYXMgXCJjaVwiXFxuYCk7XG4gICAgICBucG1UYWcgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGF3YWl0IHNldFZlcnNpb24obmV3VmVyc2lvbik7XG5cbiAgaWYgKG5wbVRhZykge1xuICAgIGF3YWl0IHB1Ymxpc2goW25wbVRhZ10pO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHB1Ymxpc2goWydjaSddKTtcbiAgfVxuXG4gIGlmIChsaW5rTGF0ZXN0KSB7XG4gICAgdHJ5IHtcbiAgICAgIGlmICghdGFncy5sYXRlc3QgfHwgc2VtdmVyLmd0ZShuZXdWZXJzaW9uLCB0YWdzLmxhdGVzdCkpIHtcbiAgICAgICAgY29uc3QgcGtnTmFtZSA9IChhd2FpdCBleGVjdXRlKGBucG0gaW5mbyAuIG5hbWVgKSkudHJpbSgpO1xuICAgICAgICBhd2FpdCBleGVjdXRlKGBucG0gZGlzdC10YWcgYWRkICR7cGtnTmFtZX1AJHtuZXdWZXJzaW9ufSBsYXRlc3RgKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGUpXG4gICAgfVxuICB9XG5cbiAgYXdhaXQgZXhlY3V0ZShgbnBtIGluZm8gLiBkaXN0LXRhZ3MgLS1qc29uYCk7XG59O1xuXG5ydW4oKS5jYXRjaChlID0+IHtcbiAgY29uc29sZS5lcnJvcihcIkVycm9yOlwiKTtcbiAgY29uc29sZS5lcnJvcihlKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufSk7XG4iXX0=